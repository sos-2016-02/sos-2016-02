<!DOCTYPE html>

<html lang="es">

<head>
<title>API REST - Olders</title>
<meta charset="utf-8" />
<script src="/js/jquery-2.2.3.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){

	var vAPIname;
	var vAPIversion;
	var vConnection;

	setDefaultValues();

	obtenerDireccion();

	$("#btnEnviar").click(function(){
		$("#txtReceived").html( "" );
		var vType     = $("input[type=radio]:checked").attr("id");
		var vDataJSON = $("#txtData").val();

		var request = $.ajax({
			 url        : vConnection
			,type       : vType
			,data       : vDataJSON
			,contentType: "application/json; charset=utf-8"
			,cache      : false
		});

		request.done(function(data, status, jqXHR){
			$("#txtStatus").text("");
			//$("#txtReceived").text( JSON.stringify(data) );
			var table = $.makeTable(data);
			$(table).appendTo("#txtReceived");
		});;

		request.always(function(jqXHR, status){
			if (status == "success"){
				$("#txtStatus").text("Ok.");
			} else {
				$("#txtStatus").text("ERROR " + jqXHR.status + " " + jqXHR.statusText);	
			}
		});;

	});

	$("input[name=txtURL]").keyup(function(){
		obtenerDireccion();
	});

	$("input[name=txtParam]").keyup(function(){
		$("#txtURI").val("");
		obtenerDireccion();
	});

	$("#txtURI").keyup(function(){
		$('input[name=txtParam]').val("");
		obtenerDireccion();
	});

	$("#selAPIname").change(function(){
		obtenerDireccion();
	});

	$("#selAPIversion").change(function(){
		obtenerDireccion();
	});

	function setDefaultValues() {
		$('input[name=txtURL]').val("");
		// https://sos-2016-02.herokuapp.com
		// http://localhost:3000
		$('#txtServer').val("https://sos-2016-02.herokuapp.com");
		$('#txtURI').val("Sevilla");
		$('#txtKey').val("keyRead");
	}

	function obtenerDireccion() {
		vAPIname    = $("#selAPIname option:selected").val();
		vAPIversion = $("#selAPIversion option:selected").val();
		vConnection = $("#txtServer").val() + "/api/" + vAPIversion + "/" + vAPIname + "/" + $("#txtURI").val();
		if ($("#apikey").val() != ""){
			var vChar  = ( vConnection.indexOf("?")==-1) ? "?" : "&";
			vConnection = vConnection + vChar + "apikey=" + $("#txtKey").val()
		}
		if ($("#txtOffset").val() != ""){
			var vChar  = ( vConnection.indexOf("?")==-1) ? "?" : "&";
			vConnection = vConnection + vChar + "offset=" + $("#txtOffset").val()
		}
		if ($("#txtLimit").val() != ""){
			var vChar  = ( vConnection.indexOf("?")==-1) ? "?" : "&";
			vConnection = vConnection + vChar + "limit=" + $("#txtLimit").val()
		}
		if ($("#txtFrom").val() != ""){
			var vChar  = ( vConnection.indexOf("?")==-1) ? "?" : "&";
			vConnection = vConnection + vChar + "from=" + $("#txtFrom").val()
		}
		if ($("#txtTo").val() != ""){
			var vChar  = ( vConnection.indexOf("?")==-1) ? "?" : "&";
			vConnection = vConnection + vChar + "to=" + $("#txtTo").val()
		}
		if ($("#txtFields").val() != ""){
			var vChar  = ( vConnection.indexOf("?")==-1) ? "?" : "&";
			vConnection = vConnection + vChar + "fields=" + $("#txtFields").val()
		}
		if ($("#txtValues").val() != ""){
			var vChar  = ( vConnection.indexOf("?")==-1) ? "?" : "&";
			vConnection = vConnection + vChar + $("#txtValues").val()
		}

		$('#lnkRequest').attr('href',vConnection);
		$('#lnkRequest').text(vConnection);
	}

	$.makeTable = function (dataJSON) {
		var table = $('<table border="1">');
		var tblHeader = "<tr>";
		for (var h in dataJSON[0]) tblHeader += "<th>" + h + "</th>";
		tblHeader += "</tr>";
		$(tblHeader).appendTo(table);
		$.each(dataJSON, function (index, value) {
			var tblRow = "<tr>";
			$.each(value, function (key, val) {
				tblRow += "<td>" + val + "</td>";
			});
			tblRow += "</tr>";
			$(table).append(tblRow);
		});
		return ($(table));
	};

});
</script>
</head>

<body>
	<header>
		<h1>JQuery REST Client</h1>
	</header>
	<section id="api">
		API:
		<select id="selAPIname">
		<option value="workers">Workers</option>
		<option value="olders" selected="selected">Olders</option>
		<option value="population">Population</option>
		</select>
		Version:
		<select id="selAPIversion">
		<option value="v1">1.0</option>
		</select>
	</section>
	<section id="connection">
		<hr/>
		<table>
		<tr><td>Server:</td><td><input type="text" name="txtURL" id="txtServer" size= "30" /></td></tr>
		<tr><td>URI:</td><td><input type="text" name="txtURL" id="txtURI" size= "30" /></td></tr>
		<tr><td>apikey:</td><td><input type="text" name="txtURL" id="txtKey" size= "30" /></td></tr>
		</table>
	</section>
	<section id="parameters">
		<hr/>
		<table>
		<tr><td>
			<fieldset>
				<legend>Pages</legend>
				<table>
				<tr><td>Offset:</td><td><input type="text" name="txtParam" id="txtOffset" size= "5" /></td></tr>
				<tr><td>Limit:</td><td><input type="text" name="txtParam" id="txtLimit" size= "5" /></td></tr>
				</table>
			</fieldset>
		</td>
		<td>
			<fieldset>
				<legend>Interval</legend>
				<table>
				<tr><td>From:</td><td><input type="text" name="txtParam" id="txtFrom" size= "5" /></td></tr>
				<tr><td>to:</td><td><input type="text" name="txtParam" id="txtTo" size= "5" /></td></tr>
				</table>
			</fieldset>
		</td></tr>
		<tr><td colspan="2">
			<fieldset>
				<legend>Filter</legend>
				<table>
				<tr><td>Fields:</td><td><input type="text" name="txtParam" id="txtFields" size= "25" />&nbsp;<img id="imgInfoFileds" src="/images/info.png" title="province,men"/></td></tr>
				<tr><td>Values:</td><td><input type="text" name="txtParam" id="txtValues" size= "25" />&nbsp;<img id="imgInfoValues" src="/images/info.png" title="year=2010&men=4827"/></td></tr>
				</table>
			</fieldset>
		</td></tr>
		</table>

	</section>
	<section id="request">
		<hr/>
		<p>Data to send (payload):<br/><textarea id="txtData" cols="40" rows = "5"></textarea></p>
		<p>Method:
		<input type="radio" name="chkMethod" id="GET" checked="checked" />GET&nbsp;
		<input type="radio" name="chkMethod" id="POST" />POST&nbsp;
		<input type="radio" name="chkMethod" id="PUT" />PUT&nbsp;
		<input type="radio" name="chkMethod" id="DELETE" />DELETE&nbsp;
		</p>
		<hr/>
		<a id="lnkRequest"></a><br/><br/>
		<input type="button" id="btnEnviar" value="SEND THIS REQUEST"/>
	</section>
	<section id="response">
		<hr/>
		<p>Status: <span id="txtStatus"></span></p>
		<p>Data received:</p><p>
		<span id="txtReceived">
			<table id="tblJSON"></table>			
		</span></p>
	</section>
</body>
</html>